### **项目代号：Wboard**

#### **一、产品定位与核心价值**

1.  **定位**: 一个轻量级、非商业化的代理服务分享与管理工具。
2.  **核心用户**: 你（管理员）和你的朋友们（用户）。
3.  **核心价值**:
    *   **对你而言**: 告别手动为朋友增删账号、排查问题的混乱，实现自动化、系统化的用户和流量管理。
    *   **对朋友而言**: 拥有一个专属的、稳定的服务。通过简单的订阅链接即可使用，无需关心复杂配置。

---

#### **二、功能规划 (MVP 版本)**

我们将功能简化到极致，只保留最核心的三个部分：**用户管理**、**节点管理**和**订阅服务**。

| 模块 | 功能点 (MVP) | 说明 |
| :--- | :--- | :--- |
| **1. 管理员后台** | 1.1 **添加/删除用户** (朋友) | 只需设置`用户名`和`密码`即可创建一个用户。系统自动生成一个唯一标识（UUID）。 |
| | 1.2 **分配流量/时长** | 为每个用户设置每月可用流量（如 100GB）或服务到期时间。 |
| | 1.3 **查看用户用量** | 直观看到每个朋友已使用的流量和剩余流量。 |
| | 1.4 **添加/删除节点** | 手动添加你的代理服务器信息（地址、端口、协议类型等）。 |
| | 1.5 **重置用户流量** | 手动为某个用户重置当月流量。 |
| **2. 用户界面** | 2.1 **用户登录** | 朋友们使用你分配的账号密码登录。 |
| | 2.2 **仪表盘** | 登录后能看到自己的`订阅链接`、`已用/总流量`、`到期时间`。 |
| | 2.3 **一键复制订阅** | 点击按钮即可复制订阅链接，方便导入客户端。 |
| **3. 核心后端服务** | 3.1 **订阅生成服务** | 这是最重要的后台服务。它能根据请求的`用户标识`，动态生成包含其可用节点的配置文件。 |
| | 3.2 **流量统计服务** | 定期（如每 5 分钟）从代理后端（如 Xray）的 API 获取所有用户的流量数据，并更新到数据库。 |
| | 3.3 **自动任务** | 每月 1 号自动重置所有用户的流量；自动禁用到期或流量超出的用户。 |

**我们刻意砍掉了什么？**
*   **工单系统**：朋友之间直接用微信沟通，效率更高。
*   **在线支付**：不涉及付费，完全移除。
*   **邀请/注册系统**：你手动添加，更可控。
*   **复杂的前端主题**：一个简洁的后台模板足矣。

---

#### **三、技术选型建议 (Python 技术栈)**

选择 Python 是个很好的决定，生态丰富，开发快速。

1.  **后端框架**: **FastAPI** 或 **Flask**。
    *   **FastAPI (推荐)**: 现代化，性能高，自带 API 文档（Swagger UI），非常适合开发此类以 API 为核心的项目。学习曲线平缓。
    *   **Flask**: 轻量级，社区庞大，自由度高。如果你对它更熟悉，也是个不错的选择。

2.  **数据库**: **SQLite** 或 **PostgreSQL**。
    *   **SQLite (MVP 首选)**: 零配置，就是一个文件。对于你目前的用户量（朋友们），性能完全足够，能让你快速启动项目，无需关心数据库部署。
    *   **PostgreSQL**: 如果你预计未来用户会增长，或者想使用更专业的数据库，可以选择它。

3.  **ORM (数据库操作)**:
    *   配合 FastAPI，使用 **SQLModel** 或者 **SQLAlchemy**。它们能让你用 Python 对象来操作数据库，非常方便。
    *   配合 Flask，使用 **Flask-SQLAlchemy**。

4.  **代理后端**: **Xray-core**。
    *   这是目前的主流选择，性能强劲，协议支持全面（VLESS/XTLS）。
    *   **关键点**: 它提供了 **API 服务**，这是我们能实现用户管理和流量统计的基础。你需要开启它的 API 功能。

5.  **前端**: **保持简单**。
    *   直接使用一个现成的后台管理模板，如 **AdminLTE**、**Tabler** 或 **Bootstrap
        Admin Dashboard**。
    *   只需要用模板引擎（如 Jinja2）渲染几个简单的 HTML 页面即可，无需复杂的前端框架（如 Vue/React），大大降低开发复杂度。

---

#### **四、核心工作流拆解**

这是项目最核心的运行逻辑，想清楚这一步，开发就成功了一半。

**场景：你的朋友 "小明" 使用服务**

1.  **你 (管理员)**:
    *   在 FriendPanel 后台，添加用户 "小明"，设置每月流量为 100GB。
    *   系统为 "小明" 在数据库中创建一条记录，并生成一个唯一的 UUID（例如 `abc-123`）。
    *   你将后台地址、账号和密码发给小明。

2.  **Xray 服务端**:
    *   你需要在 Xray 的配置文件中，开启 API 服务。
    *   然后在 Inbound (入站协议) 设置里，通过 API menambah "小明" 这个用户，并指定他的 UUID 为 `abc-123`。
        *   **关键**：这一步可以通过你的 **FriendPanel 后端程序自动完成**。当你点击“添加用户”时，后端程序不仅要写数据库，还要调用 Xray 的 API，将新用户同步过去。

3.  **小明 (用户)**:
    *   登录 FriendPanel，看到自己的订阅链接，形如 `https://your-domain.com/sub/abc-123`。
    *   复制该链接，导入到 Clash/V2RayN 等客户端。

4.  **订阅过程**:
    *   小明的客户端向 `https://your-domain.com/sub/abc-123` 发起一个 GET 请求。
    *   你的 **FastAPI 应用**捕获这个请求，解析出 UUID `abc-123`。
    *   后端程序：
        a.  根据 UUID 从数据库查询 "小明" 的信息，确认他是否有效（未超流量、未过期）。
        b.  从数据库读取所有**可用节点**的信息。
        c.  动态生成一份符合 Clash 或 V2Ray 格式的配置文件文本，并将节点信息填入。
        d.  将这份文本作为响应返回给小明的客户端。
    *   小明的客户端收到配置，开始使用代理。

5.  **流量统计**:
    *   你的 **FastAPI 应用**中有一个**定时任务**（例如每 5 分钟执行一次）。
    *   该任务会调用 **Xray 的 API**，获取所有用户（通过 UUID 区分）在这 5 分钟内产生的流量。
    *   后端程序将这些流量数据累加到数据库里 "小明" 对应记录的 `used_traffic` 字段上。
    *   小明在仪表盘上刷新，就能看到最新的流量使用情况。

---

#### **五、开发步骤建议**

1.  **Step 1: 环境搭建**
    *   部署 Xray-core 并手动配置成功，确保代理能用。**开启它的 API 服务是重中之重**。
    *   安装 Python, FastAPI, Uvicorn, SQLAlchemy, SQLite。

2.  **Step 2: 数据库设计**
    *   设计 `User` 表 (id, username, password_hash, uuid, traffic_limit, traffic_used, due_date)
    *   设计 `Node` 表 (id, name, address, port, protocol_type, config_details)

3.  **Step 3: 后端 API 优先**
    *   **先写 API**，暂时不管前端页面。
    *   编写**核心订阅接口** `/sub/{user_uuid}`。先用假数据测试，确保能返回正确的配置文件格式。
    *   编写**与 Xray API 交互的逻辑**，实现“添加/删除用户”和“查询流量”这两个关键功能。使用 Postman 或类似工具测试 API。

4.  **Step 4: 开发管理后台和用户界面**
    *   集成一个 Admin 模板。
    *   编写简单的登录、后台管理（增删改查）、用户仪表盘页面，并与后端 API 对接。

5.  **Step 5: 部署**
    *   使用 Gunicorn + Nginx 来部署你的 FastAPI 应用。
    *   配置好域名和 HTTPS。